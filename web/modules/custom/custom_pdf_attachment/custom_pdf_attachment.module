<?php

use Drupal\commerce_order\Entity\OrderInterface;
use Drupal\Core\Render\Markup;
use Drupal\commerce_product\Entity\ProductVariation;
use Drupal\file\Entity\File;

/**
 * Implements hook_mail_alter().
 */
function custom_pdf_attachment_mail_alter(&$message) {
    // Check if this is the order confirmation email.
    if ($message['key'] === 'receipt') {
        // Load the order from the email parameters.
        $order = $message['params']['order'];
        if ($order instanceof OrderInterface) {
            // Loop through the order items.
            foreach ($order->getItems() as $order_item) {
                // Manually load the product variant using target_id.
                $variant_id = $order_item->get('purchased_entity')->target_id;
                $purchased_entity = ProductVariation::load($variant_id);

                if ($purchased_entity && $purchased_entity->hasField('field_product_file') && !$purchased_entity->get('field_product_file')->isEmpty()) {
                    // Get the PDF file from the product variant.
                    $pdf_file = $purchased_entity->get('field_product_file')->entity;
                    if ($pdf_file instanceof File) {
                        // Attach the PDF file to the email.
                        $file_path = $pdf_file->getFileUri();
                        $message['params']['attachments'][] = [
                            'filepath' => $file_path,
                            'filename' => $pdf_file->getFilename(),
                            'filemime' => $pdf_file->getMimeType(),
                        ];
                    }
                }
            }
        }
    }
}