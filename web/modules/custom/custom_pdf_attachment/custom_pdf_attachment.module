<?php

use Drupal\commerce_order\Entity\OrderInterface;
use Drupal\Core\Render\Markup;
use Drupal\commerce_product\Entity\ProductVariation;
use Drupal\file\Entity\File;

/**
 * Implements hook_mail_alter().
 */
function custom_pdf_attachment_mail_alter(&$message) {
    \Drupal::logger('custom_debug')->notice('Mail alter triggered for email key: ' . $message['key']);

    // Ensure this is the order confirmation email.
    if ($message['key'] === 'commerce_order_receipt') {
        \Drupal::logger('custom_debug')->notice('Processing order receipt email.');

        // Load the order entity from the email parameters.
        $order = $message['params']['order'];

        if ($order instanceof OrderInterface) {
            \Drupal::logger('custom_debug')->notice('Order found: ' . $order->id());

            $attachments = [];

            // Loop through each order item.
            foreach ($order->getItems() as $order_item) {
                $variant_id = $order_item->get('purchased_entity')->target_id;

                if (!empty($variant_id)) {
                    $product_variant = ProductVariation::load($variant_id);
                    \Drupal::logger('custom_debug')->notice('Product Variant loaded: ' . $variant_id);

                    if ($product_variant && $product_variant->hasField('field_product_file') && !$product_variant->get('field_product_file')->isEmpty()) {
                        $file = $product_variant->get('field_product_file')->entity;

                        if ($file instanceof File) {
                            // Attach the PDF file to the email.
                            $file_path = $file->getFileUri();
                            $attachments[] = [
                                'filepath' => $file_path,
                                'filename' => $file->getFilename(),
                                'filemime' => $file->getMimeType(),
                            ];
                            \Drupal::logger('custom_debug')->notice('PDF attached: ' . $file->getFilename());
                        } else {
                            \Drupal::logger('custom_debug')->warning('File entity is missing.');
                        }
                    } else {
                        \Drupal::logger('custom_debug')->warning('No file found in field_product_file.');
                    }
                } else {
                    \Drupal::logger('custom_debug')->warning('No variant ID found.');
                }
            }

            if (!empty($attachments)) {
                $message['params']['attachments'] = $attachments;
            } else {
                \Drupal::logger('custom_debug')->warning('No attachments added.');
            }
        } else {
            \Drupal::logger('custom_debug')->warning('Order entity is not valid.');
        }
    }
}